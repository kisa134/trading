# Blueprint только для сервисов, которые реально есть в репозитории.
# Воркеры analytics.* (tape_aggregator, iceberg_detector и др.) отключены — пакета analytics нет.
# После появления analytics — добавьте их в этот файл.

services:
  - type: web
    name: trading-api
    env: python
    rootDir: trading_platform
    buildCommand: pip install -r requirements.txt
    startCommand: python -m api.main --host 0.0.0.0 --port $PORT
    envVars:
      - fromGroup: trading-env-5mux

  - type: web
    name: trading-frontend
    env: static
    rootDir: trading_platform/frontend
    buildCommand: npm install && npm run build
    staticPublishPath: dist
    envVars:
      - key: VITE_API_URL
        value: https://trading-api-5mux.onrender.com

  - type: worker
    name: hot-storage
    env: python
    rootDir: trading_platform
    buildCommand: pip install -r requirements.txt
    startCommand: python -m storage.hot --redis $REDIS_URL
    envVars:
      - fromGroup: trading-env-5mux

  - type: worker
    name: ingestor-bybit
    env: python
    rootDir: trading_platform
    buildCommand: pip install -r requirements.txt
    startCommand: python -m ingestors.bybit.main --redis $REDIS_URL --symbol BTCUSDT
    envVars:
      - fromGroup: trading-env-5mux

  - type: worker
    name: ingestor-binance
    env: python
    rootDir: trading_platform
    buildCommand: pip install -r requirements.txt
    startCommand: python -m ingestors.binance.main --redis $REDIS_URL --symbol BTCUSDT
    envVars:
      - fromGroup: trading-env-5mux

  - type: worker
    name: ingestor-okx
    env: python
    rootDir: trading_platform
    buildCommand: pip install -r requirements.txt
    startCommand: python -m ingestors.okx.main --redis $REDIS_URL --symbol BTCUSDT
    envVars:
      - fromGroup: trading-env-5mux

  - type: worker
    name: cold-writer
    env: python
    rootDir: trading_platform
    buildCommand: pip install -r requirements.txt
    startCommand: python -m storage.cold --redis $REDIS_URL
    envVars:
      - fromGroup: trading-env-5mux

  - type: worker
    name: graph-writer
    env: python
    rootDir: trading_platform
    buildCommand: pip install -r requirements.txt
    startCommand: python -m storage.graph_writer --redis $REDIS_URL
    envVars:
      - fromGroup: trading-env-5mux

  - type: worker
    name: tick-anomaly
    env: python
    rootDir: trading_platform
    buildCommand: pip install -r requirements.txt
    startCommand: python -m services.mamba_core.tick_anomaly --redis $REDIS_URL --exchange bybit --symbol BTCUSDT
    envVars:
      - fromGroup: trading-env-5mux

  - type: worker
    name: celery-worker
    env: python
    rootDir: trading_platform
    buildCommand: pip install -r requirements.txt
    startCommand: celery -A celery_app worker -l info
    envVars:
      - fromGroup: trading-env-5mux

  - type: worker
    name: celery-beat
    env: python
    rootDir: trading_platform
    buildCommand: pip install -r requirements.txt
    startCommand: celery -A celery_app beat -l info
    envVars:
      - fromGroup: trading-env-5mux

envVarGroups:
  - name: trading-env-5mux
    envVars:
      - key: REDIS_URL
        sync: false
      - key: OPENROUTER_API_KEY
        sync: false
      - key: COLD_STORAGE_URL
        sync: false
      - key: NEO4J_URI
        sync: false
      - key: NEO4J_USER
        sync: false
      - key: NEO4J_PASSWORD
        sync: false
